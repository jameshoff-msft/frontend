import Head from 'next/head'
import styles from '../styles/Home.module.css'
import { Button, Modal } from 'react-bootstrap'
import { useState } from 'react'

// Importing the Bootstrap CSS
import 'bootstrap/dist/css/bootstrap.min.css';

import useSWR from 'swr'

const fetcher = url => fetch(url).then(r => r.json())

export default function Home() {

  const [image, setImage] = useState(null);
  const documentFetchResults = useSWR('/api/v1/leases', fetcher)

  const [document, setDocument] = useState(null)

  //modal states
  const [show, setShow] = useState(false);
  const handleClose = () => setShow(false);
  const handleShow = () => setShow(true);

  const [showFail, setShowFail] = useState(false);
  const handleCloseFail = () => setShowFail(false);
  const handleShowFail = () => setShowFail(true);

  const uploadToClient = async (event) => {
    try {
      if (event.target.files && event.target.files[0]) {
        const i = event.target.files[0];

        if (i.name) {
          console.log(`image : ${i}`)
          setImage(i.name);
          // setCreateObjectURL(URL.createObjectURL(i));
          const body = new FormData();
          body.append("file", i);
          console.log("sending...")
          const response = await fetch("/api/v1/documents/upload", {
            method: "POST",
            body
          });
          setShow(true)
          console.log(` response ${JSON.stringify(response.body)}`)
        } else {
          setShowFail(true)
        }

      }
    } catch (err) {
      console.log(err)
      setShowFail(true)
    }
  };

  const colors = ["#007BEB", "#20B883", "#A0F09A", "#E0056C", "#000FF0", "#60C6F7"]

  const highlightText = (text, offset, textLength, color) => {
    const result = text.substring(0, offset - 1) + ` <span style="background-color:${color}">` + text.substring(offset, offset + textLength) + `</span> ` +
      text.substring(offset + textLength + 1, document.ocr.length);
    return result
  }

  const getText = () => {
    if (document) {
      let currentText = document.ocr
      let colorIndex = 0
      let categories = {}
      console.log(`ner : ${JSON.stringify(document.ner)}`)
      for (let i = document.ner.length - 1; i >= 0; i--) {
        console.log(`ner category ${document.ner[i].category}`)
        let color = null
        if (categories[document.ner[i].category]) {
          color = categories[document.ner[i].category]
        } else {
          categories[document.ner[i].category] = colors[colorIndex % colors.length]
          color = colors[colorIndex % colors.length]
          colorIndex++
        }
        currentText = highlightText(currentText, document.ner[i].offset, document.ner[i].length, color)
      }
      const keys = Object.keys(categories)
      const values = []
      for (const k of keys) {
        values.push({ [k]: categories[k] })
      }

      console.log(JSON.stringify(values))
      return (
        <div style={{padding : 30}}dangerouslySetInnerHTML={{ __html: currentText }}></div>
      );
    }
  }

  const documentSelected = async (selectedDocument) => {
    setDocument(selectedDocument)
  }

  const parseData = (documents) => {
    if (documents && documents.data) {
      return (
        <>
          {documents.data.map(document => (
            <div className="filename" onClick={() => { documentSelected(document) }}>{document.filename}</div>
          ))}
        </>
      )
    }
    return (<></>)
  }

  const showLegend = () => {
    if (document) {
      let currentText = document.ocr
      let colorIndex = 0
      let categories = {}
      console.log(`ner : ${JSON.stringify(document.ner)}`)
      for (let i = document.ner.length - 1; i >= 0; i--) {
        console.log(`ner category ${document.ner[i].category}`)
        let color = null
        if (categories[document.ner[i].category]) {
          color = categories[document.ner[i].category]
        } else {
          categories[document.ner[i].category] = colors[colorIndex % colors.length]
          color = colors[colorIndex % colors.length]
          colorIndex++
        }
        currentText = highlightText(currentText, document.ner[i].offset, document.ner[i].length, color)
      }
      const keys = Object.keys(categories)
      const values = []
      for (const k of keys) {
        values.push({ key : k, value : categories[k] })
      }

      console.log(JSON.stringify(values))
      return (
        <>
          {values.map(v => (
            <>
              <div><span class="dot" style={{backgroundColor:v.value}  }></span> {v.key}</div>
            </>
          ))}
        </>
      )
    }
  }


  return (

    <div className={styles.container}>
      <Head>

        <title>Lease Analysis</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <Modal show={show} onHide={handleClose}>
          <Modal.Header closeButton>
            <Modal.Title>File Uploaded</Modal.Title>
          </Modal.Header>
          <Modal.Body>{image} uploaded successfully!</Modal.Body>
          <Modal.Footer>
            <Button variant="secondary" onClick={handleClose}>
              Close
            </Button>
          </Modal.Footer>
        </Modal>
        <Modal show={showFail} onHide={handleCloseFail}>
          <Modal.Header closeButton>
            <Modal.Title>File Upload Failed</Modal.Title>
          </Modal.Header>
          <Modal.Body>{image} did not upload successfully.  Check the logs for more information.</Modal.Body>
          <Modal.Footer>
            <Button variant="secondary" onClick={handleCloseFail}>
              Close
            </Button>
          </Modal.Footer>
        </Modal>
        <div>
          <label class="custom-file-upload">
            <input type="file" name="myImage" onChange={uploadToClient} />
            Select PDF File
          </label>
        </div>
        <div className="documentTextParent">
          <div className="filenames">
          {parseData(documentFetchResults)}
          </div>
          <div className="documentText">
            {getText()}
          </div>
          <div >
            {showLegend()}
          </div>

        </div>

      </main>

      <footer className={styles.footer}>

      </footer>
    </div>
  )
}


export async function getStaticProps(context) {

  return {
    props: {}, // will be passed to the page component as props
  }
}
